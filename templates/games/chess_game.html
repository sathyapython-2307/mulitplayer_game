{% extends 'base.html' %}
{% block title %}Chess Game{% endblock %}
{% block extra_css %}
<style>
    .chess-board { 
        display: grid; 
        grid-template-columns: repeat(8, 1fr); 
        max-width: 600px; 
        margin: 0 auto;
        border: 4px solid var(--teal-dark);
        border-radius: 10px;
        overflow: hidden;
    }
    .chess-square { 
        aspect-ratio: 1; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        font-size: 3rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    .chess-square.light { background: #f0d9b5; }
    .chess-square.dark { background: #b58863; }
    .chess-square.selected { background: #7fc97f !important; box-shadow: inset 0 0 10px rgba(0,0,0,0.3); }
    .chess-square.valid-move { background: #ffd700 !important; }
    .chess-square:hover { opacity: 0.8; transform: scale(0.95); }
    .piece { user-select: none; }
    .turn-indicator { padding: 15px; border-radius: 10px; margin-bottom: 20px; }
    .turn-indicator.active { background: linear-gradient(135deg, var(--teal-primary), var(--teal-secondary)); color: white; }
    .turn-indicator.waiting { background: var(--teal-bg); color: var(--teal-text); }
    .bot-badge { background: linear-gradient(135deg, #9333ea, #c026d3); color: white; padding: 5px 15px; border-radius: 20px; }
</style>
{% endblock %}
{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0"><i class="bi bi-chess-queen"></i> Chess Game</h5>
                    <small>Code: <strong>{{ game.code }}</strong></small>
                </div>
                <div>
                    {% if game.is_bot_game %}
                    <span class="bot-badge"><i class="bi bi-robot"></i> vs AI</span>
                    {% endif %}
                    <button class="btn btn-danger btn-sm ms-2" id="resign-btn">
                        <i class="bi bi-flag"></i> Resign
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="turn-indicator text-center" id="turn-indicator">
                    <h6 class="mb-0" id="turn-text">Loading...</h6>
                </div>
                
                <div class="chess-board" id="chess-board"></div>
                
                <div class="text-center mt-4">
                    <p class="text-muted">
                        You are playing as: <strong class="text-warm">{{ player_color|title }}</strong><br>
                        Opponent: <strong>{{ opponent }}</strong>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="gameOverModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warm text-white">
                <h5 class="modal-title"><i class="bi bi-trophy"></i> Game Over</h5>
            </div>
            <div class="modal-body text-center py-4">
                <h4 id="winner-text"></h4>
                <p id="reason-text" class="text-muted"></p>
            </div>
            <div class="modal-footer">
                <a href="{% url 'chess_lobby' %}" class="btn btn-warm">Back to Lobby</a>
                <a href="{% url 'chess_matchmaking' %}" class="btn btn-outline-warm">New Game</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
const gameCode = '{{ game.code }}';
const playerColor = '{{ player_color }}';
const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
const socket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chess/${gameCode}/`);

let boardState = {};
let currentTurn = 'white';
let selectedSquare = null;
let isBotGame = {{ game.is_bot_game|lower }};
let botColor = '{{ game.bot_color }}';

const pieceSymbols = {
    'wp': 'â™™', 'wn': 'â™˜', 'wb': 'â™—', 'wr': 'â™–', 'wq': 'â™•', 'wk': 'â™”',
    'bp': 'â™Ÿ', 'bn': 'â™ž', 'bb': 'â™', 'br': 'â™œ', 'bq': 'â™›', 'bk': 'â™š'
};

socket.onmessage = (e) => {
    const data = JSON.parse(e.data);
    
    if (data.type === 'game_state' || data.type === 'game_update') {
        boardState = data.board_state;
        currentTurn = data.current_turn;
        if (data.is_bot_game !== undefined) isBotGame = data.is_bot_game;
        if (data.bot_color) botColor = data.bot_color;
        renderBoard();
        updateTurnIndicator();
    } else if (data.type === 'game_over') {
        showGameOver(data.winner, data.reason);
    }
};

function renderBoard() {
    const board = document.getElementById('chess-board');
    board.innerHTML = '';
    
    const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
    const ranks = playerColor === 'white' ? [8,7,6,5,4,3,2,1] : [1,2,3,4,5,6,7,8];
    
    ranks.forEach((rank, rIdx) => {
        files.forEach((file, fIdx) => {
            const square = `${file}${rank}`;
            const isLight = (rIdx + fIdx) % 2 === 0;
            const div = document.createElement('div');
            div.className = `chess-square ${isLight ? 'light' : 'dark'}`;
            div.dataset.square = square;
            
            if (boardState[square]) {
                const piece = document.createElement('span');
                piece.className = 'piece';
                piece.textContent = pieceSymbols[boardState[square]];
                div.appendChild(piece);
            }
            
            div.addEventListener('click', () => handleSquareClick(square));
            board.appendChild(div);
        });
    });
}

function handleSquareClick(square) {
    if (currentTurn !== playerColor) return;
    
    if (selectedSquare) {
        // Make move
        if (square !== selectedSquare) {
            socket.send(JSON.stringify({
                type: 'move',
                from: selectedSquare,
                to: square
            }));
        }
        clearSelection();
    } else {
        // Select piece
        if (boardState[square] && boardState[square][0] === playerColor[0]) {
            selectedSquare = square;
            document.querySelector(`[data-square="${square}"]`).classList.add('selected');
        }
    }
}

function clearSelection() {
    if (selectedSquare) {
        const elem = document.querySelector(`[data-square="${selectedSquare}"]`);
        if (elem) elem.classList.remove('selected');
        selectedSquare = null;
    }
}

function updateTurnIndicator() {
    const indicator = document.getElementById('turn-indicator');
    const text = document.getElementById('turn-text');
    
    if (currentTurn === playerColor) {
        indicator.className = 'turn-indicator text-center active';
        text.textContent = 'ðŸŽ¯ Your Turn!';
    } else {
        indicator.className = 'turn-indicator text-center waiting';
        if (isBotGame && currentTurn === botColor) {
            text.textContent = 'ðŸ¤– AI is thinking...';
        } else {
            text.textContent = 'â³ Opponent\'s Turn';
        }
    }
}

function showGameOver(winner, reason) {
    const modal = new bootstrap.Modal(document.getElementById('gameOverModal'));
    const winnerText = document.getElementById('winner-text');
    const reasonText = document.getElementById('reason-text');
    
    if (winner === playerColor) {
        winnerText.textContent = 'ðŸŽ‰ You Won!';
        winnerText.className = 'text-success';
    } else {
        winnerText.textContent = 'ðŸ˜” You Lost';
        winnerText.className = 'text-danger';
    }
    
    reasonText.textContent = reason === 'resignation' ? 'Opponent resigned' : 'Checkmate';
    modal.show();
}

document.getElementById('resign-btn').addEventListener('click', () => {
    if (confirm('Are you sure you want to resign?')) {
        socket.send(JSON.stringify({ type: 'resign' }));
    }
});

renderBoard();
</script>
{% endblock %}
